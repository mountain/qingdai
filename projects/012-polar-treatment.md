# Project 012: 极点处理（Polar Corrections）——洋流速度与海温（SST）

## 0. 状态（2025-09-21）
- [x] M1：在海洋模块中实现并集成极点修正（标量平均 + 矢量统一坐标平均）
- [ ] M2：扩展到其它需要的标量（可选：海冰厚度诊断等）的极点一致化
- [ ] M3：文档与可视化示例完善（极点前后对比）

关联代码：`pygcm/ocean.py`  
新增内部函数：
- `_polar_scalar_average_fill(F, ocean_mask)`
- `_polar_vector_average_fill(u, v, ocean_mask)`  
调用位置：`WindDrivenSlabOcean.step()` 末尾；开关：`QD_OCEAN_POLAR_FIX=1`（默认启用）

---

## 1. 背景与动机

本项目网格为规则经纬度网格，包含 ±90° 的极点纬线（南北极各一行）。在几何上，极点处所有经度对应同一个物理点。若不做处理，沿极圈将获得多个数值样本（例如 240 个经度），会导致：
- 标量（如海表温度 SST）在同一物理点被赋予多个不一致的值；
- 矢量（如洋流速度 (u, v)）的局地基底随经度旋转，直接逐经度平均会出现方向抵消或非物理结果。

对于大气而言，我们采用谱方法（或已有的极点正则化），规避了极点奇异性。对于海洋与海温，本项目实现了极点修正，以保证数值与物理一致性。

---

## 2. 处理原则

- 标量：极点经度圈上的海洋网格取均值，并回填该极圈的所有海洋格点（陆地不变）。
- 矢量：将每个经度的局地（east, north）分量映射到“同一个极点的局部切平面”中统一表达，再对矢量做平均，然后将平均结果变换回各自经度下的（east, north）分量，回填海洋格点。

这样，极点处的“多经度同物理点”的样本被一致化处理；标量保证一致，矢量在统一坐标系下平均，避免经向基底旋转带来的伪抵消。

---

## 3. 数学描述

### 3.1 标量（SST）极点平均
记极点所在行索引为 `j=0`（南极）与 `j=-1`（北极），记海洋掩膜为 `ocean_mask`（海洋为 True/1）。  
对每个极点行：
- 计算该行海洋格点上的标量均值 `S̄`；
- 将该均值填回该行所有海洋经度位置。

### 3.2 矢量（洋流速度 u, v）极点平均（基于局部切平面 3D 表达）
采用标准球面正交基：
- 东向单位向量（与纬度无关）：
  - `e_east(λ) = (-sinλ, cosλ, 0)`
- 北向单位向量在极点的极限（位于切平面内）：
  - 北极（+90°）：`e_north^N(λ) = (-cosλ, -sinλ, 0)`
  - 南极（-90°）：`e_north^S(λ) = ( cosλ,  sinλ, 0)`

对极点行的每个海洋经度 λ_i：
1) 将局地分量 `(u_i, v_i)` 表达成切平面 3D 向量  
   `V_i = u_i · e_east(λ_i) + v_i · e_north^(pole)(λ_i)`
2) 在极点统一切平面中对所有 `V_i` 取向量平均：`V̄ = mean(V_i)`  
3) 将 `V̄` 投影回每个经度的局地基底，得到回填量：
   - `u_fill(λ) = e_east(λ) · V̄`
   - `v_fill(λ) = e_north^(pole)(λ) · V̄`

仅对海洋格点执行回填，陆地保持不变。  
若某极点整圈均为陆地，则跳过该极点修正。

该过程在几何上确保了：
- 在同一物理点（极点），各经度的矢量先以相同的切平面坐标表示，再进行平均；
- 平均结果与经度无关（统一物理点的一致矢量），然后映射回各经度的局地基（以便与网格存储一致）。

---

## 4. 算法步骤（伪代码）

```
# 标量（以 Ts 为例）
for pole_row in [0, -1]:
    mask = ocean_mask[pole_row, :]
    if any(mask):
        mean_val = mean(Ts[pole_row, mask])
        Ts[pole_row, mask] = mean_val

# 矢量（以 uo, vo 为例）
for pole_row, pole in [(0, "south"), (-1, "north")]:
    mask = ocean_mask[pole_row, :]
    if not any(mask): continue
    idx = where(mask)
    lam_sel = lons_rad[idx]
    ee_sel = [-sin(lam_sel),  cos(lam_sel), 0]
    en_sel = [±cos(lam_sel), ±sin(lam_sel), 0]   # 号根据南/北极选择
    u_sel = uo[pole_row, idx]
    v_sel = vo[pole_row, idx]
    V3 = ee_sel * u_sel + en_sel * v_sel
    V̄ = mean(V3)
    # 回填（对整圈构建基底，回填时仅对 ocean_mask 为 True 的经度写入）
    ee_all, en_all = basis_over_all_lons(pole)
    u_fill = dot(ee_all, V̄)
    v_fill = dot(en_all, V̄)
    uo[pole_row, mask] = u_fill[mask]
    vo[pole_row, mask] = v_fill[mask]
```

---

## 5. 实现与接口

- 文件：`pygcm/ocean.py`
- 函数：
  - `_polar_scalar_average_fill(self, F, ocean_mask)`：标量极点平均并回填
  - `_polar_vector_average_fill(self, u, v, ocean_mask)`：矢量极点统一坐标平均并回填
- 集成位置：
  - `WindDrivenSlabOcean.step()` 的末尾，在每个海洋时间步完成后调用（默认启用）
- 环境变量开关：
  - `QD_OCEAN_POLAR_FIX`：1（默认启用）/ 0（关闭）
- 掩膜约定：
  - `land_mask == 1` 表示陆地，`== 0` 表示海洋。极点回填仅作用于海洋网格。  
  - 注：当前极点回填未额外使用 `ice_mask`；海冰下的速度与热通量在各自模块路径中控制（如动量/热通量/蒸发等）。

---

## 6. 数值稳定性与复杂度

- 复杂度：每步仅对两条极圈执行 O(n_lon) 操作，开销可忽略。
- 稳定性：基于局部切平面 3D 表达，避免了极点处经向基底旋转带来的数值不稳定与非物理平均。
- 容错：实现中使用 `try/except` 防御，遇到数值异常将跳过该步极点回填（不中断主循环）。

---

## 7. 与其它模块的关系

- 大气（谱模式）：不受影响，仍按既有方案避免极点问题。
- 能量（P006）/湿度（P008）：通过更一致的极点 SST/洋流，间接改善近极区的热力与水汽通量计算。
- 海冰（P007）：海冰对热/水通量与 SST 演化的影响仍按既有路径；极点回填不直接改变海冰厚度或口径。
- 水循环（P009）：极点处 E−P 诊断受更稳定的 SST/风应力影响，收支更一致。

---

## 8. 验收与诊断建议

- 视觉对比：开启/关闭 `QD_OCEAN_POLAR_FIX`，对比极点附近的 SST 与 (uo, vo) 场，检查是否消除“经度条纹”与不一致。
- 数值指标：
  - 极点两行的 SST 方差显著降低；
  - 极点两行的 (uo, vo) 在各经度基底下的差异减小（在统一切平面下应近似一致）。
- 守恒与闭合：与 P006/P008/P009 的诊断一致性不受负面影响（极点仅做局部一致化，不改变全局守恒核算逻辑）。

---

## 9. 运行示例

```bash
# 启用海洋与极点修正（默认已启用）
export QD_USE_OCEAN=1
export QD_OCEAN_POLAR_FIX=1

# 常规建议参数（示例）
export QD_SIGMA4_OCEAN=0.02
export QD_OCEAN_DIFF_EVERY=1
export QD_OCEAN_K4_NSUB=1

python3 -m scripts.run_simulation
```

---

## 10. 后续扩展

- 将同样的标量极点一致化用于其它极区诊断量（例如可选的海冰诊断图层、经验性云层覆盖等），保持一致视觉与数值表现。
- 若未来引入海冰动力学，可在极点回填后对冰速实施一致化/钳制（另行设计，不在本里程碑）。
- 在可视化工具中增加“极点一致化前后”的对比图面板，辅助验收。

---

## 11. 设计决策小结

- “标量取极圈均值并回填；矢量在统一局部坐标系平均再回填”的做法，严格遵循“极点经度圈代表同一物理点”的几何事实。
- 该处理仅作用于最外圈两行（±90°），对中低纬度无任何影响。
- 大气保持原谱方案，避免混杂两种极点处理路径；海洋/海温采用本文的最小一致化方案，简洁稳健且高效。
