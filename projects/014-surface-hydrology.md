# Project 014: 地表水文与径流路由模型 (Surface Hydrology & Runoff Routing)

## 0. 状态 (2025-09-23)
- [ ] 文档与方案定稿 (本文件)
- [ ] M1: 离线流向网络与湖泊盆地预计算工具
- [ ] M2: 在线径流演算与流量累积模块
- [ ] M3: GCM 主循环集成与新诊断输出（含湖泊）
- [ ] M4: 可视化增强（河流网络与湖泊叠加）
- [ ] M5: 参数标定与验证（径流时标、汇流速度等）

**关联模块**: P004 (地形生成), P005 (地形接入), P009 (行星水循环闭合)

---

## 1. 背景与动机

当前的水循环框架 (P009) 成功地实现了全球 E-P-R 的水量闭合。陆地“桶模型”能够计算出每个网格产生的径流量 `R`，但这部分径流被假设为瞬时返回全球海洋，没有在陆地上形成汇流过程。

这一简化是当前模型**刻画局部生态条件**的最大瓶颈。河流、湖泊、湿地等关键生态地貌的形成，完全依赖于地表径流的汇聚。没有径流的方向和累积，我们便无法区分干旱的山脊和湿润的河谷，也无法为后续的植被、农业和文明演化模拟提供最关键的**局地水资源分布**数据。

**本项目目标**：在计算成本可控的前提下，建立一个基于地形的表面径流路由模型，模拟江河湖海的形成，从而精确刻画局部的水文条件。

---

## 2. 核心策略：解耦时间尺度

为了避免将高计算成本的流体模拟引入GCM的每个时间步，我们采用“**离线预计算 + 在线异步更新**”的高效策略。

### 2.1 离线预计算：流向网络与湖泊识别

* **物理基础**: 水的流动路径主要由**静态的地形**决定。洼地（Pits/Sinks）是天然的汇水点，是湖泊形成的基础。
* **操作**: 创建一个一次性运行的独立脚本 (`scripts/generate_hydrology_maps.py`)。该脚本将：
    1.  读取 P004 生成的高精度地形 NetCDF 文件 (`elevation` 场)。
    2.  **洼地填充 (Pit Filling)**: 采用标准算法，识别所有地形洼地，并模拟“注水”过程，将其填平至最低的溢出点（spill point）。这个过程将产出：
        * 一个无洼地的、水文连通的地形高程图。
        * 一个**湖泊掩膜 (Lake Mask)**，标示出所有潜在湖泊的位置和最大范围。
        * 一个**湖平面高程场**。
    3.  **计算流向**: 在“填平后”的地形上，为每个陆地格点计算其**流向**（例如，使用D8算法确定水流向八个邻居中的哪一个），并修正湖泊区域内的流向，使其指向溢出点。
    4.  **计算演算顺序**: 通过拓扑排序，确定从上游到下游的演算顺序，确保水流计算的正确性。
    5.  将“流向图”、“演算顺序”和“湖泊掩膜”保存到一个新的 NetCDF 文件中 (例如 `data/hydrology_network.nc`)。
* **计算成本**: 这部分计算完全**独立于 GCM 模拟**，属于一次性的数据预处理。

### 2.2 在线异步更新：流量累积与湖泊水量平衡

* **物理基础**: 地表径流的汇集和河湖水量的变化，其时间尺度远大于大气环流的分钟级变化。
* **操作**:
    1.  在 GCM 主循环 (`run_simulation.py`) 中，每个 GCM 时间步 (`dt`) 正常计算出每个格点的径流量 `R`。
    2.  将 `R` 在一个更长的时间窗口（“水文步长” `dt_hydro`，例如1小时或6小时）内进行**累积**。
    3.  **每隔一个水文步长**，调用一次径流演算函数。该函数将：
        * 读取预计算好的“流向图”，把累积的径流量从上游向下游进行分配和累加，形成**流量累积场 (Flow Accumulation)**，即河流。
        * 对于被标记为湖泊的网格，单独计算其水量平衡：`ΔVolume = (入湖流量 + 局地降水 - 蒸发) * dt_hydro`。湖泊的水位和面积可根据其水量和预计算的盆地地形进行动态调整（简化方案中可暂不考虑动态面积）。当湖泊蓄满后，多余的水量将从溢出点流出，汇入下游河道。
* **计算成本**: 通过将执行频率降低一个数量级以上，它对GCM总计算时间的增加将是**微不足道的**。

---

## 3. 任务分解与里程碑

* **M1: 离线流向网络与湖泊盆地预计算工具**
    * [ ] 新建脚本 `scripts/generate_hydrology_maps.py`。
    * [ ] 实现**洼地填充 (Pit Filling)** 算法，以识别湖泊掩膜和溢出点。
    * [ ] 实现 D8 (或类似) 算法，在水文连通的地形上计算流向。
    * [ ] 实现拓扑排序，确定演算顺序。
    * [ ] 将流向图、演算顺序和湖泊掩膜导出为标准 NetCDF 文件。

* **M2: 在线径流演算与流量累积模块**
    * [ ] 新建模块 `pygcm/routing.py` (或扩展 `pygcm/hydrology.py`)。
    * [ ] 实现 `class RiverRouting`，在初始化时加载 `hydrology_network.nc`。
    * [ ] 实现 `step(self, R_flux, P_flux, E_flux, dt)` 方法，该方法累积径流量，并在达到 `dt_hydro` 时，执行一次全图的流量演算和**湖泊水量平衡计算**。
    * [ ] 模块需维护新的状态场：`flow_accumulation` (流量累积) 和 `lake_volume` (湖泊蓄水量)。

* **M3: GCM 主循环集成与新诊断输出**
    * [ ] 在 `scripts/run_simulation.py` 中初始化 `RiverRouting` 实例。
    * [ ] 在主循环的水文步骤中，将相关通量传入 `routing.step()`。
    * [ ] 将湖泊视为新的地表类型，在计算地表能量平衡时，使用水体的热惯性参数。
    * [ ] 新增诊断输出：全球总径流量、最大流量、总湖泊蓄水量等。

* **M4: 可视化增强**
    * [ ] 扩展 `plot_state` 函数或新建脚本。
    * [ ] 将 `flow_accumulation` 场可视化，清晰地展示河流网络。
    * [ ] 将预计算的**湖泊掩膜**叠加到“真彩色”图和地表温度图上，使其成为行星地理的永久特征。

* **M5: 参数标定与验证**
    * [ ] 标定水文步长 `dt_hydro`，在效率和精度之间取得平衡。
    * [ ] 验证：检查河流是否总是从高处流向低处，最终汇入湖泊或海洋。

---

## 4. 接口与数据结构 (建议)

* **`hydrology_network.nc` 文件**:
    * `flow_direction` (n_lat, n_lon, dtype=int8): 编码1-8代表八个方向。
    * `flow_order` (N_land_cells, 2, dtype=int16): 陆地格点的 `(lat_idx, lon_idx)` 列表，按计算顺序排列。
    * `lake_mask` (n_lat, n_lon, dtype=uint8): 标记湖泊位置的二值掩膜。
* **`pygcm/routing.py` API**:
    * `class RiverRouting(grid, network_path)`
    * `step(self, R_flux_land, P_flux_land, E_flux_land, dt)`
    * `get_flow_accumulation() -> np.ndarray`
    * `get_lake_mask() -> np.ndarray`

---

## 5. 与其他项目的交叉引用

* **P009 (行星水循环闭合)**: 本项目是 P009 的直接下游和重要升级。它将P009计算出的径流量`R`转化为有物理意义的地表水分布，使水循环的闭合路径更加真实。
* **未来生态/文明模型**: 本项目的输出（河流网络、湖泊、局地水资源分布）将是所有依赖于水资源分布的后续模型的**关键基础数据**。